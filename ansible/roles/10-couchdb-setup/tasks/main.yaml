-debug:
  msg: "CouchDB IPs: {{ couchdb_instance_0_ip }}','{{ couchdb_instance_1_ip }}', '{{ couchdb_instance_2_ip }}, {{ web_front_end_ip }}"

- name: Run setup for couchdb_0
  remote_user: ubuntu
  shell: "{{ item }}"
  with_items:

    # Setup Volume Mount:
    - sudo mkfs -t ext4 /dev/vdb

    # Mount Volume:
    - sudo mkdir /couchdb
    - sudo mount /dev/vdb /couchdb

    # Build Dockerfile
    - echo "FROM couchdb:3.0.1
      \nEXPOSE 5984
      \nEXPOSE 4369
      \nEXPOSE 9100
      \nENV COUCHDB_USER=admin
      \nENV COUCHDB_PASSWORD=password
      \nENV NODENAME='{{ couchdb_instance_0_ip }}'" > Dockerfile


    # Build and Start Docker Instance
    - sudo docker build -t cdb .
    - sudo docker run --name couchdb -p 4369:4369 -p 5984:5984 -p 9100:9100 -v /couchdb:/opt/couchdb/data -d cdb


    # Set up Cluster TBD





    # Clone Repo
    - git clone https://benjamin-129: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@github.com/benjamin-129/cluster-a2.git

    # Install dependencies
    - sudo apt-get update -y
    - sudo apt install python3-pip -y
    - sudo apt install screen -y

    - cd cluster-a2/tweet_harvester
    - pip3 install -r requirements.txt -y


  delegate_to: '{{ couchdb_instance_0_ip }}'


- name: Run setup for couchdb_1
  remote_user: ubuntu
  shell: "{{ item }}"
  with_items:

    # Setup Volume Mount:
    - sudo mkfs -t ext4 /dev/vdb

    # Mount Volume:
    - sudo mkdir /couchdb
    - sudo mount /dev/vdb /couchdb

    # Build Dockerfile
    - echo "FROM couchdb:3.0.1
      \nEXPOSE 5984
      \nEXPOSE 4369
      \nEXPOSE 9100
      \nENV COUCHDB_USER=admin
      \nENV COUCHDB_PASSWORD=password
      \nENV NODENAME='{{ couchdb_instance_1_ip }}'" > Dockerfile


    # Build and Start Docker Instance
    - sudo docker build -t cdb .
    - sudo docker run --name couchdb -p 4369:4369 -p 5984:5984 -p 9100:9100 -v /couchdb:/opt/couchdb/data -d cdb

    # Clone Repo
    - git clone https://benjamin-129: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@github.com/benjamin-129/cluster-a2.git

    # Install dependencies
    - sudo apt-get update -y
    - sudo apt install python3-pip -y
    - sudo apt install screen -y

    - cd cluster-a2/tweet_harvester
    - pip3 install -r requirements.txt -y


  delegate_to: '{{ couchdb_instance_1_ip }}'


- name: Run setup for couchdb_2
  remote_user: ubuntu
  shell: "{{ item }}"
  with_items:

    # Setup Volume Mount:
    - sudo mkfs -t ext4 /dev/vdb

    # Mount Volume:
    - sudo mkdir /couchdb
    - sudo mount /dev/vdb /couchdb

    # Build Dockerfile
    - echo "FROM couchdb:3.0.1
      \nEXPOSE 5984
      \nEXPOSE 4369
      \nEXPOSE 9100
      \nENV COUCHDB_USER=admin
      \nENV COUCHDB_PASSWORD=password
      \nENV NODENAME='{{ couchdb_instance_2_ip }}'" > Dockerfile


    # Build and Start Docker Instance
    - sudo docker build -t cdb .
    - sudo docker run --name couchdb -p 4369:4369 -p 5984:5984 -p 9100:9100 -v /couchdb:/opt/couchdb/data -d cdb

    # Clone Repo
    - git clone https://benjamin-129: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@github.com/benjamin-129/cluster-a2.git

    # Install dependencies
    - sudo apt-get update -y
    - sudo apt install python3-pip -y
    - sudo apt install screen -y

    - cd cluster-a2/tweet_harvester
    - pip3 install -r requirements.txt -y


  delegate_to: '{{ couchdb_instance_2_ip }}'



- name: Start Harvesters couch0
  shell: "{{ item }}"
  with_items:
    - screen -q
    - python3 harvest.py 0 localhost
    - screen -d

  delegate_to: '{{ couchdb_instance_0_ip }}'

- name: Start Harvesters couch1
  shell: "{{ item }}"
  with_items:
    - screen -q
    - python3 harvest.py 1 localhost
    - screen -d

  delegate_to: '{{ couchdb_instance_1_ip }}'

- name: Start Harvesters couch2
  shell: "{{ item }}"
  with_items:
    - screen -q
    - python3 harvest.py 2 localhost
    - screen -d

  delegate_to: '{{ couchdb_instance_2_ip }}'
  

  